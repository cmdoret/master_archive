select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), vars(Fo,Fe,Mo,Me))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), vars(c("Fo","Fe","Mo","Me")))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars(c("Fo","Fe","Mo","Me")))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_all(funs(round(.,0)), .vars(c("Fo","Fe","Mo","Me")))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_all(funs(round(.,0)), vars(c("Fo","Fe","Mo","Me")))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), vars(c("Fo","Fe","Mo","Me")))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), c("Fo","Fe","Mo","Me"))
jtjt <-c("Fo","Fe","Mo","Me")
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), vars(jtjt))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
View(odds_list)
df <- apply(odds_list, 1,  get_fisher)
df
View(df)
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="two.sided")
return(f$p.value)
}
df <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
View(odds_list)
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=fisher)) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
groups_path <- "../../data/assoc_mapping/mother_groups.tsv"
groups <- read.table(groups_path, header = T)
sum_stat <- sum_stat[sum_stat$N.Males>0 & sum_stat$N.Females>0,]
sum_stat <- sum_stat[!is.na(sum_stat$Prop.Hom),]
sum_stat$cluster <- groups$cluster[match(sum_stat$Family, groups$Family)]
sum_stat <- sum_stat[!is.na(sum_stat$cluster),]
cat_stat <- sum_stat %>%
group_by(Locus.ID, Chr, BP, cluster) %>%
summarise(Nf=sum(N.Females), Nm=sum(N.Males), N=sum(N.Samples),
Prop.Hom=sum(Prop.Hom*N.Samples, na.rm=T)/sum(N.Samples, na.rm=T),
Prop.Hom.F=sum(Prop.Hom.F*N.Females, na.rm=T)/sum(N.Females, na.rm=T),
Prop.Hom.M=sum(Prop.Hom.M*N.Males, na.rm=T)/sum(N.Males, na.rm=T))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate(EFo = Ft * To, EMo = Mt * To, EFe = Ft * Te, EMe = Mt * Te) %>%
mutate(chi2 = (Fo-EFo)^2/EFo + (Mo-EMo)^2/EMo + (Fe-EFe)^2/EFe + (Me-EMe)^2/EMe)
odds_list$pval <- sapply(X = odds_list$chi2, function(x) pchisq(x, df=1, lower.tail=F, log.p=T))
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="two.sided")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- by(data = odds_list$fisher,INDICES = cluster,function(x) p.adjust(x, method = "bonferroni")
#========= VISUALISE ========#
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
#======= WRITE OUTPUT =======#
# Number of groups is (2^n)-1 where n is the number of CSD loci
nloci <- log2(max(groups$cluster)+1)
write.table(odds_chrom, paste0(out_folder, "case_control_hits_", nloci , "loci.tsv"),
sep='\t', row.names=F, quote=F)
odds_list$fisher <- by(data = odds_list$fisher,INDICES = cluster,function(x) p.adjust(x, method = "bonferroni"))
odds_list$fisher <- by(data = odds_list$fisher,INDICES = odds_listcluster,function(x) p.adjust(x, method = "bonferroni"))
odds_list$fisher <- by(data = odds_list$fisher,INDICES = odds_list$cluster,function(x) p.adjust(x, method = "bonferroni"))
View(odds_list)
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
View(sum_stat)
View(odds_list)
odds_list$fisher <- by(data = odds_list$fisher,INDICES = odds_list$cluster,function(x) p.adjust(x, method = "bonferroni"))
odds_list$fisher <- 1
odds_list$fisher <- 1
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "bonferroni")
}
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "HB")
}
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() +
xlab("Genomic position") + ylab("-log2 p-value") + ggtitle("Case-control associaiton test for CSD")
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_line() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$cluster = 1
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "HB")
}
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- p.adjust(odds_list$fisher, method = "HB")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "HB")
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$cluster <- 1
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
sum_stat$cluster <- 1
sum_stat$cluster
sum_stat <- sum_stat[!is.na(sum_stat$cluster),]
cat_stat <- sum_stat %>%
group_by(Locus.ID, Chr, BP, cluster) %>%
summarise(Nf=sum(N.Females), Nm=sum(N.Males), N=sum(N.Samples),
Prop.Hom=sum(Prop.Hom*N.Samples, na.rm=T)/sum(N.Samples, na.rm=T),
Prop.Hom.F=sum(Prop.Hom.F*N.Females, na.rm=T)/sum(N.Females, na.rm=T),
Prop.Hom.M=sum(Prop.Hom.M*N.Males, na.rm=T)/sum(N.Males, na.rm=T))
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate(EFo = Ft * To, EMo = Mt * To, EFe = Ft * Te, EMe = Mt * Te) %>%
mutate(chi2 = (Fo-EFo)^2/EFo + (Mo-EMo)^2/EMo + (Fe-EFe)^2/EFe + (Me-EMe)^2/EMe)
f <- fisher.test(as.table(mat), alt="two.sided")
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="two.sided")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.05))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() + geom_hline(aes(yintercept=-log10(0.01))) +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.05)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
View(odds_chrom)
sum_stat$cluster <- groups$cluster[match(sum_stat$Family, groups$Family)]
sum_stat <- sum_stat[!is.na(sum_stat$cluster),]
cat_stat <- sum_stat %>%
group_by(Locus.ID, Chr, BP, cluster) %>%
summarise(Nf=sum(N.Females), Nm=sum(N.Males), N=sum(N.Samples),
Prop.Hom=sum(Prop.Hom*N.Samples, na.rm=T)/sum(N.Samples, na.rm=T),
Prop.Hom.F=sum(Prop.Hom.F*N.Females, na.rm=T)/sum(N.Females, na.rm=T),
Prop.Hom.M=sum(Prop.Hom.M*N.Males, na.rm=T)/sum(N.Males, na.rm=T))
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="two.sided")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "BH")
}
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
library(dplyr);library(readr);library(ggplot2)
in_args <- commandArgs(trailingOnly = T)
groups_path <- in_args[1]
groups <- read.table(groups_path, header = T)
groups_path <- "../../data/assoc_mapping/mother_groups.tsv"
hom_path <- "../../data/assoc_mapping/grouped_prophom.tsv"
groups <- read.table(groups_path, header = T)
sum_stat <- read_tsv(file=hom_path, col_names=T, col_types = "iciddddddc")
sum_stat <- sum_stat[sum_stat$N.Males>0 & sum_stat$N.Females>0,]
sum_stat <- sum_stat[!is.na(sum_stat$Prop.Hom),]
#!!!!!! TODO !!!!!!#
# Map families to mother categories
sum_stat$cluster <- groups$cluster[match(sum_stat$Family, groups$Family)]
sum_stat <- sum_stat[!is.na(sum_stat$cluster),]
# Group SNP by mother category
cat_stat <- sum_stat %>%
group_by(Locus.ID, Chr, BP, cluster) %>%
summarise(Nf=sum(N.Females), Nm=sum(N.Males), N=sum(N.Samples),
Prop.Hom=sum(Prop.Hom*N.Samples, na.rm=T)/sum(N.Samples, na.rm=T),
Prop.Hom.F=sum(Prop.Hom.F*N.Females, na.rm=T)/sum(N.Females, na.rm=T),
Prop.Hom.M=sum(Prop.Hom.M*N.Males, na.rm=T)/sum(N.Males, na.rm=T))
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="greater")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher)))  + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher)))  + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
sum_stat$cluster <- 1
sum_stat <- sum_stat[!is.na(sum_stat$cluster),]
cat_stat <- sum_stat %>%
group_by(Locus.ID, Chr, BP, cluster) %>%
summarise(Nf=sum(N.Females), Nm=sum(N.Males), N=sum(N.Samples),
Prop.Hom=sum(Prop.Hom*N.Samples, na.rm=T)/sum(N.Samples, na.rm=T),
Prop.Hom.F=sum(Prop.Hom.F*N.Females, na.rm=T)/sum(N.Females, na.rm=T),
Prop.Hom.M=sum(Prop.Hom.M*N.Males, na.rm=T)/sum(N.Males, na.rm=T))
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="greater")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher)))  + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher)))  + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
f <- fisher.test(as.table(mat), alt="less")
f <- fisher.test(as.table(mat), alt="less")
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="less")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "BH")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher)))  + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher)))  + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="greater")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "BH")
}
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
f <- fisher.test(as.table(mat), alt="less")
return(f$p.value)
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="less")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "BH")
}
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
f <- fisher.test(as.table(mat), alt="two.sided")
get_fisher <- function(df){
mat <- matrix(as.numeric(df[c(8:11)]), ncol=2)
f <- fisher.test(as.table(mat), alt="two.sided")
return(f$p.value)
}
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
for(group in unique(odds_list$cluster)){
odds_list$fisher[odds_list$cluster==group] <- p.adjust(odds_list$fisher[odds_list$cluster==group], method = "BH")
}
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
odds_list <- cat_stat %>%
rename(Ft = Nf, Mt = Nm, Tt = N) %>%
mutate(Fo = Ft * Prop.Hom.F, Mo = Mt * Prop.Hom.M,
Fe = Ft * (1-Prop.Hom.F), Me = Mt * (1-Prop.Hom.M),
To = Tt * Prop.Hom, Te = Tt * (1-Prop.Hom)) %>%
select(-Prop.Hom, -Prop.Hom.F, -Prop.Hom.M) %>%
mutate_at(funs(round(.,0)), .vars = c("Fo","Fe","Mo","Me"))
odds_list$fisher <- apply(odds_list, 1,  get_fisher)
odds_list$fisher <- p.adjust(odds_list$fisher, method = "bonferroni")
odds_chrom <- odds_list[grep("chr.*",odds_list$Chr),]
ggplot(data=odds_chrom, aes(x=BP, y=-log10(fisher))) + facet_grid(cluster~Chr, scales='free_x') + geom_point() +
geom_hline(aes(yintercept=-log10(0.05))) + geom_hline(aes(yintercept=-log10(0.01)), lty=2, col='red') +
xlab("Genomic position") + ylab("-log10 p-value") + ggtitle("Case-control associaiton test for CSD")
