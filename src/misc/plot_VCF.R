# This script plots summary statistics from the populations VCF output file.
# The summary statistics need to be provided by a file generated by parse_VCF
# Cyril Matthey-Doret
# 01.05.2017


args = commandArgs(trailingOnly=TRUE)  
# Changing working directory to source directory. Prevents inheriting wd of bash/makekfile
# script if not directly running this script
#setwd(args[1])

plot_popstats <- function(sum_file,stats){
  # sum_file: path to the input summary file
  # stats: parameter to be plotted. Needs to be a colname
  sex_palette <- c('pink','blue')  # Color palette used to represent sex
  sum_table <- read.table(file=sum_file,sep='\t',header=T)  # reading input file
  sum_table$SEX <- sapply(sum_table$INDV,function(x) substr(x,8,8))  # Extracting sex info from sample name
  sum_table$FAMILY <- sapply(sum_table$INDV,function(x) substr(x,4,4))  # Extracting family info from sample name
  sum_table$INDV <- sapply(sum_table$INDV,function(x) substr(x,4,6))  # Shortening sample name
  if(stats=='PROP'){
   sum_table$PROP <- sum_table$O.HOM./ sum_table$E.HOM.
  }
  pl_row <- length(unique(sum_table$FAMILY)) / 2  # Plots spread over 2 rows
  par(mfrow=c(2,pl_row))
  sum_table <- sum_table[with(sum_table, order(FAMILY,sum_table[,stats])), ]
  for(f in unique(sum_table$FAMILY)){
    subt <- sum_table[sum_table$FAMILY==f,]
    barplot(height = subt[,stats],
            names.arg = subt$INDV,
            col =  sex_palette[as.factor(subt$SEX)],main=f)
    MF <- mean(subt[subt$SEX=='F',stats]); SF <- sd(subt[subt$SEX=='F',stats])
    MM <- mean(subt[subt$SEX=='M',stats]); SM <- sd(subt[subt$SEX=='M',stats])
    abline(h = MF,col="pink")
    # abline(h = MF-SF,col="pink");abline(h = MF+SF,col="pink",lty=2)
    abline(h = MM,col="blue")
    # abline(h = MM-SM,col="blue",lty=2);abline(h = MM+SM,col="blue",lty=2)
    par(xpd=NA)
    scoef <- nrow(subt)/20
    polygon(x=c(-5,-3,-3,-5)*scoef,y=c(MF-SF,MF-SF,MF+SF,MF+SF), 
            col=rgb(1, 0.75, 0.8,0.6),lty = 1,border=NA)
    polygon(x=c(-3,-1,-1,-3)*scoef,y=c(MM-SM,MM-SM,MM+SM,MM+SM), 
            col=rgb(0, 0, 1,0.6),lty = 1,border=NA)
    par(xpd=FALSE)
  }
}

plot_corr <- function(sum_file,stat1,stat2){
  # sum_file: path to the input summary file
  # stat1, stat2: parameters to be plotted. Needs to be colnames
  sex_palette <- c('pink','blue')  # Color palette used to represent sex
  sum_table <- read.table(file=sum_file,sep='\t',header=T)  # reading input file
  sum_table$SEX <- sapply(sum_table$INDV,function(x) substr(x,8,8))  # Extracting sex info from sample name
  sum_table$FAMILY <- sapply(sum_table$INDV,function(x) substr(x,4,4))  # Extracting family info from sample name
  sum_table$INDV <- sapply(sum_table$INDV,function(x) substr(x,4,6))  # Shortening sample name
  sum_table$PROP <- sum_table$O.HOM./ sum_table$E.HOM.
  pl_row <- length(unique(sum_table$FAMILY)) / 2  # Plots spread over 2 rows
  par(mfrow=c(2,pl_row))
  for(f in unique(sum_table$FAMILY)){
    subt <- sum_table[sum_table$FAMILY==f,]
    corr <- format(cor.test(x = subt[,stat1],y = subt[,stat2],method = 'pearson')$estimate,digits = 2)
    pv <- format(cor.test(x = subt[,stat1],y = subt[,stat2],method = 'pearson')$p.value,digits = 2)
    plot(x = subt[,stat1],y = subt[,stat2],xlab='mean depth',ylab='F(IS)',
            col =  sex_palette[as.factor(subt$SEX)],main=paste0(f,': cor= ',corr,'; p=',pv))
  }
}

param_space <- seq(75,85,5)
ref_table <- read.table(file="vcftools/summary_r-75",sep='\t',header=T)
out_table <- matrix(nrow = length(param_space),ncol = 7)
out_table <- as.data.frame.array(out_table)
colnames(out_table) <- c("R","O.HOM.","E.HOM.","N_SITES","F","MEAN_DEPTH","PROP")
out_table$R <- param_space
for(p in param_space){
  pdf(paste0("vcftools/corr_depth_r-",p,".pdf"),width = 9)
  plot_corr(paste0("vcftools/summary_r-",p),'MEAN_DEPTH','F')
  dev.off()
  for(param in c("O.HOM.","E.HOM.","N_SITES","F","MEAN_DEPTH","PROP")){
    if(param %in% c('F','MEAN_DEPTH','PROP')){
      pdf(paste0("vcftools/",param,"_r-",p,".pdf"),width = 9)
      plot_popstats(paste0("vcftools/summary_r-",p),param)
      dev.off()
    }
    tmp_tbl <- read.table(paste0("vcftools/summary_r-",p),header = T,sep="\t")
    tmp_tbl$PROP <- tmp_tbl$O.HOM./ tmp_tbl$E.HOM.
    out_table[out_table$R==p,param] <- mean(tmp_tbl[,param])
  }
}
out_table <- data.frame(lapply(out_table, function(y) if(is.numeric(y)) round(y, 2) else y))
colnames(out_table) <- c("r parameter","obs.hom.","exp.hom.","n.sites","inbreed.coef.","mean depth","obs./exp. hom.")
write.table(out_table,file='vcftools/vcf_sumtable.csv',col.names = T,quote = F,row.names = F,sep=',')
system("cp vcftools/vcf_sumtable.csv vcftools/F_r-75.pdf ../../reports/lab_book/")

# REMINDER: ctrl-shift-C in Rstudio to comment/uncomment multiple lines
 # for(p in param_space){
 #  pdf(paste0("vcftools/","full_corr_r-",p,".pdf"),width = 9)
 #  sex_palette <- c('pink','blue')  # Color palette used to represent sex
 #  sum_table <- read.table(file=paste0("vcftools/summary_r-",p),sep='\t',header=T)  # reading input file
 #  sum_table$SEX <- sapply(sum_table$INDV,function(x) substr(x,8,8))  # Extracting sex info from sample name
 #  sum_table$FAMILY <- sapply(sum_table$INDV,function(x) substr(x,4,4))  # Extracting family info from sample name
 #  sum_table$INDV <- sapply(sum_table$INDV,function(x) substr(x,4,6))  # Shortening sample name
 #  sum_table$PROP <- sum_table$O.HOM./ sum_table$E.HOM.
 #  corr <- format(cor.test(x = sum_table[,'MEAN_DEPTH'],y = sum_table[,'F'],method = 'pearson')$estimate,digits = 2)
 #  pv <- format(cor.test(x = sum_table[,'MEAN_DEPTH'],y = sum_table[,'F'],method = 'pearson')$p.value,digits = 2)
 # 
 #  plot(x = sum_table[,'MEAN_DEPTH'],y = sum_table[,'F'],xlab='mean depth',ylab='F(IS)',
 #       col =  sex_palette[as.factor(sum_table$SEX)],main=paste0('cor= ',corr,'; p=',pv))
 #  dev.off()
 # }

